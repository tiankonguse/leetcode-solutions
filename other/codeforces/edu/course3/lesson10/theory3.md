## Двумерные и многомерные префиксные суммы, поиск суммы на прямоугольнике
二维和多维前缀和，在矩形上求和

https://codeforces.com/edu/course/3/lesson/10/3


Двумерный случай 二维案例
Мы уже научились искать сумму на отрезке в одномерном массиве при помощи префиксных сумм, но префиксные суммы легко обобщаются и на бóльшие размерности. Давайте научимся искать сумму на прямоугольнике в двумерном массиве. Пусть нам дан двумерный массив 𝑎𝑖,𝑗
. Определим его префиксные суммы так:
我们已经学习了如何使用前缀和在一维数组中的区间上搜索和，但前缀和可以轻松推广到更大的维度。让我们学习如何求二维数组中矩形的和。给我们一个二维数组 𝑎𝑖,𝑗
 。我们将其前缀和定义如下：

𝑏𝑖+1,𝑗+1=∑𝑥≤𝑖 ∑𝑦≤𝑗𝑎𝑥,𝑦=𝑎0,0+𝑎0,1+𝑎0,2+…+𝑎0,𝑗+𝑎1,0+𝑎1,1+…+𝑎1,𝑗+…+𝑎𝑖,0+𝑎𝑖,1+…+𝑎𝑖,𝑗

Для двумерных префиксных сумм тоже полезно представлять, что они находятся между значениями исходного массива в узлах сетки и отвечают за сумму всего, что выше и левее этой точки.
对于二维前缀和，将它们视为位于网格节点处的原始数组的值之间并负责该点上方和左侧所有内容的总和也是有用的。

Можно воспринимать происходящее, как будто мы построили префиксные суммы по одной координате, а затем посчитали префиксные суммы префиксных сумм по другой координате.
您可以感知正在发生的事情，就好像我们沿着一个坐标构造前缀和，然后沿着另一个坐标计算前缀和的前缀和。



Таким образом, можно насчитать префиксные суммы на одномерных массивах, а потом насчитать префиксные суммы на массивах префиксных сумм.
因此，您可以计算一维数组的前缀和，然后计算前缀和数组的前缀和。


```cpp
vector<vector<int>> findPrefixSums2D(vector<vector<int>>& a) {
    int n = a.size();
    int m = a[0].size();
    vector<vector<int>> prefixSum1D(n);
    for (int i = 0; i < n; i++) {
        prefixSum1D[i] = findPrefixSums(a[i]);
    }
    vector<vector<int>> prefixSum2D(n + 1, vector<int>(m + 1, 0));
    for (int j = 0; j <= m; j++) {
        for (int i = 0; i < n; i++) {
            prefixSum2D[i + 1][j] = prefixSum2D[i][j] + prefixSum1D[i][j];
        }
    }
    return prefixSum2D;
}
```


Альтернативный вариант подсчета префиксных сумм — вновь воспользоваться рекуррентной формулой. Это будет немного сложнее, чем в одномерном случае. Формула выглядит следующим образом:
计算前缀金额的另一种选择是再次使用递归公式。这将比一维情况稍微复杂一些。公式如下：

𝑏𝑖+1,𝑗+1=𝑏𝑖,𝑗+1+𝑏𝑖+1,𝑗−𝑏𝑖,𝑗+𝑎𝑖,𝑗

Эту формулу легко понять из картинки:
这个公式从图中就很容易理解了：



Мы берем сумму двух меньших префиксных сумм, которые накрывают нашу, однако их пересечение учтется дважды, поэтому его надо вычесть. Но ведь это пересечение — это и есть 𝑏𝑖,𝑗
. И в конце стоит не забыть прибавить новый элемент — 𝑎𝑖,𝑗
.
我们取覆盖我们的两个较小前缀和的总和，但它们的交集将被计算两次，因此必须将其相减。但这个交叉点就是这样 𝑏𝑖,𝑗
 。最后，不要忘记添加一个新元素 - 𝑎𝑖,𝑗
 。

Элементы, через которые мы считаем 𝑏𝑖+1,𝑗+1
 имеют меньшие индексы, поэтому подсчет двумерных префиксных сумм можно вести просто двумя вложенными циклами по возрастанию.
我们计算的元素 𝑏𝑖+1,𝑗+1
 由于索引较小，所以二维前缀和的计算可以简单地通过两个升序嵌套循环来完成。


```cpp
vector<vector<int>> findPrefixSums2D(vector<vector<int>>& a) {
    int n = a.size();
    int m = a[0].size();
    vector<vector<int>> prefixSum(n + 1, vector<int>(m + 1, 0));
    for (int i = 0; i < n; i++) {
        for (int j = 0; j < m; j++) {
            prefixSum[i + 1][j + 1] = prefixSum[i][j + 1] + prefixSum[i + 1][j] - prefixSum[i][j] + a[i][j];
        }
    }
    return prefixSum;
}
```


Теперь пускай нам надо найти сумму на «полупрямоугольнике» (двумерный полуинтервал) с противоположными углами в точках (𝑙𝑥,𝑙𝑦)
 и (𝑟𝑥,𝑟𝑦)
 (левые границы — включительно, правые — исключительно). Сумма элементов на этом полупрямоугольнике будет выражаться так:
现在假设我们需要求一个“半矩形”（二维半区间）上的和，该“半矩形”上的点具有相反的角度 (𝑙𝑥,𝑙𝑦)
 和 (𝑟𝑥,𝑟𝑦)
 （左边界是包容性的，右边界是排除性的）。该半矩形上的元素之和将表示为：

∑𝑙𝑥≤𝑖<𝑟𝑥 ∑𝑙𝑦≤𝑗<𝑟𝑦𝑎𝑖,𝑗=𝑏𝑟𝑥,𝑟𝑦−𝑏𝑙𝑥,𝑟𝑦−𝑏𝑟𝑥,𝑙𝑦+𝑏𝑙𝑥,𝑙𝑦

Эту формулу также легче понимать, смотря на картинку:
这个公式看图也比较容易理解：



Сначала мы взяли большой прямоугольник, который накрывает нужный нам, потом удалили ненужное слева и сверху, но то, что находится на их пересечении, мы удалили дважды, так что надо вернуть это пересечение назад.
首先，我们取了一个大矩形来覆盖我们需要的矩形，然后我们删除了左侧和上方不需要的矩形，但是我们删除了它们交集处的两次，所以我们需要返回这个交集。

Стоит обратить внимание на то, что именно в двумерном случае, а также больших размерностях становится видна мощь полуинтервалов. В формуле нет ни одной цифры (±1
). Мы просто берем префиксные суммы на краях и складываем и вычитаем их.
值得注意的是，在二维情况以及更高维度中，半间隔的威力才变得可见。公式中没有一个数字（ ±1
 ）。我们只需获取边上的前缀和并对其进行加减即可。

Если бы мы определяли 𝑏𝑖,𝑗
 как сумму на отрезке, то есть ∑𝑥≤𝑖∑𝑦≤𝑗𝑎𝑥,𝑦
, то формула для суммы на прямоугольнике выглядела бы следующим образом:
如果我们要定义 𝑏𝑖,𝑗
 作为线段上的总和，即 ∑𝑥≤𝑖∑𝑦≤𝑗𝑎𝑥,𝑦
 ，那么矩形上的总和的公式将如下所示：

𝑏𝑟𝑥,𝑟𝑦−𝑏𝑙𝑥−1,𝑟𝑦−𝑏𝑟𝑥,𝑙𝑦−1+𝑏𝑙𝑥−1,𝑙𝑦−1

Вероятность написать эти формулы правильно постепенно стремится к нулю.
正确写出这些公式的概率逐渐趋于零。

Трехмерный случай 3D案例

Мы разобрались с двумерным случаем, теперь пойдем еще дальше! Префиксные суммы на трехмерном массиве определяются аналогично:
我们已经处理了二维情况，现在让我们更进一步！三维数组上的前缀和的定义类似：

𝑏𝑖+1,𝑗+1,𝑘+1=∑𝑥≤𝑖 ∑𝑦≤𝑗 ∑𝑧≤𝑘𝑎𝑥,𝑦,𝑧

Рекуррентная формула для их подсчета будет такая:
计算它们的循环公式为：

𝑏𝑖+1,𝑗+1,𝑘+1=𝑏𝑖,𝑗+1,𝑘+1+𝑏𝑖+1,𝑗,𝑘+1+𝑏𝑖+1,𝑗+1,𝑘−𝑏𝑖+1,𝑗,𝑘−𝑏𝑖,𝑗+1,𝑘−𝑏𝑖,𝑗,𝑘+1+𝑏𝑖,𝑗,𝑘+𝑎𝑖,𝑗,𝑘

И для поиска суммы на «полупараллелепипеде» (трехмерном полуинтервале) с противоположными углами в точках (𝑙𝑥,𝑙𝑦,𝑙𝑧)
 и (𝑟𝑥,𝑟𝑦,𝑟𝑧)
 подойдет следующая формула:
并求“半平行六面体”（三维半间隔）上各点具有相反角度的总和 (𝑙𝑥,𝑙𝑦,𝑙𝑧)
 和 (𝑟𝑥,𝑟𝑦,𝑟𝑧)
 以下公式即可：

∑𝑙𝑥≤𝑖<𝑟𝑥 ∑𝑙𝑦≤𝑗<𝑟𝑦 ∑𝑙𝑧≤𝑘<𝑟𝑧𝑎𝑖,𝑗,𝑘=𝑏𝑟𝑥,𝑟𝑦,𝑟𝑧−𝑏𝑙𝑥,𝑟𝑦,𝑟𝑧−𝑏𝑟𝑥,𝑙𝑦,𝑟𝑧−𝑏𝑟𝑥,𝑟𝑦,𝑙𝑧+𝑏𝑟𝑥,𝑙𝑦,𝑙𝑧+𝑏𝑙𝑥,𝑟𝑦,𝑙𝑧+𝑏𝑙𝑥,𝑙𝑦,𝑟𝑧−𝑏𝑙𝑥,𝑙𝑦,𝑙𝑧

Формулы страшные! Но показываю я вам их для того, чтобы сформулировать правила, по которым они работают в общем случае для любой размерности.
公式太可怕了！但我向你们展示它们是为了制定它们在任何维度的一般情况下工作的规则。
Потому что если у вас есть пространственное мышление, то по картинке придумать формулу для трехмерного случая вы еще сможете, а вот для четырехмерного уже вряд ли.
因为如果你有空间思维，那么从图片中你仍然可以得出三维情况的公式，但对于四维情况则不太可能。

Теорема о рекуррентной формуле подсчета префиксных сумм
计算前缀和的循环公式定理

В рекуррентной формуле подсчета префиксных сумм мы берем комбинацию всех возможных вариантов вычитания единиц из индексов. При этом если мы вычли нечетное количество единиц, то слагаемое идет с плюсом, а если четное, то с минусом.
在计算前缀和的循环公式中，我们采用所有可能选项的组合来从索引中减去单位。此外，如果我们减去奇数个单位，则该项带有加号，如果是偶数个单位，则带有减号。
В конце нужно не забыть еще прибавить один новый элемент изначального массива 𝑎
.
最后，您需要记住向原始数组添加一个新元素 𝑎
 。

Понять, почему именно нечетное с плюсом, можно по тому, что мы точно знаем, что слагаемые, в которых всего из одной координаты вычли единицу, должны идти с плюсом, ведь при их помощи мы накрываем изначально нашу префиксную сумму, а потом уже остальными пытаемся ее корректировать.
您可以理解为什么加号是奇怪的，因为我们确信从一个坐标中减去一的项必须带有加号，因为在它们的帮助下，我们首先覆盖了我们的前缀和，然后我们尝试与其他人一起纠正它。

Теорема о формуле поиска суммы на полупараллелепипеде
半平行六面体求和公式定理

Аналогичное правило есть и для формулы поиска суммы на полупараллелепипеде. Берется сумма всевозможных комбинаций левых и правых границ по каждой координате, при этом если левых границ четное количество, то слагаемое берется с плюсом, а если нечетное, то с минусом.
在半平行六面体上求和的公式也有类似的规则。取每个坐标的左边界和右边界的所有可能组合的总和，如果左边界有偶数个，则该项用加号取，如果是奇数个则用减号。

Опять же, понять, почему именно четное с плюсом, а нечетное с минусом, очень легко: слагаемое, в котором все границы правые — это самое большое слагаемое, которое мы потом корректируем, так что оно точно должно быть с плюсом.
同样，很容易理解为什么偶数带有加号，而奇数带有减号：所有边界都在右侧的项是最大的项，然后我们对其进行更正，因此它肯定必须带有加号。

Упражнение 锻炼

При помощи этих двух незатейливых правил попробуйте составить формулы для построения префиксных сумм и поиска суммы на (полу)гиперпрямоугольнике в четырехмерном пространстве.
使用这两个简单的规则，尝试创建用于构造前缀和并在四维空间中的（半）超矩形上求和的公式。

Замечания 笔记

Обратите внимание, что трехмерный префиксный массив можно насчитать другим способом так же как и двумерный: сначала посчитать одномерные префиксные суммы, потом на них насчитать двумерные и затем уже на них посчитать трехмерные.
请注意，三维前缀数组的计算方式与二维前缀数组的计算方式不同：先计算一维前缀和，然后计算二维前缀和，然后计算三维前缀和。他们身上的那些。

Если вы знаете, что такое формула включений-исключений, то в каком-то смысле именно она и применяется при построении и при ответе на запросы в многомерных префиксных суммах.
如果您知道包含-排除公式是什么，那么从某种意义上说，它就是在多维前缀和中构造和回答查询时使用的公式。
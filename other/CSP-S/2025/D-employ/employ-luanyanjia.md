设 `f(i,j,k​)` 是前 i 位，当前有 j 个人寄了，有 k 个 x 满足 `1≤x≤i ∧ c[x]​≤j`，只考虑所有 `c≤j`​ 的人的排列的方案数。

设 `t[i]` 是 `c[x]=i` 的 x 的个数，`s` 是 `t` 的前缀和。

直接转移，c 是 j 变大的时候枚举的要填在前面的 `c[x]​=j+1` 的个数。


当 `s[i]=1`：

填 `>j` 的数：`f(i+1, j,k) ← f(i,j,k)`。
填 `≤j` 的数：`f(i+1, j+1, k+c+1) ← f(i,j,k) * C(c, i-k) * C(c, t[j+1]​) * c! * (s[j]−k)`

当 `s[i]=0`：

填 `≤j` 的数：`f(i+1,j+1,k+c+1) ← f(i,j,k) * C(c, i-k) * C(c, t[j+1]​) * c! * (s[j]−k)`
填 `j+1`：`f(i+1,j+1,k+c) ← f(i,j,k) * C(c−1, i−k) * C(c, t[j+1]​) * c!`
填 `>j` 的数：`f(i+1,j+1,k+c) ← f(i,j,k) * C(c, i−k) * C(c, t[j+1]​) * c!`

答案就是 `sum(f(n,i,s[i]) * ​​(n−s[i]​)!), 1<=i<=n-m`。

一层里面所有 c 之和是 `O(n)` 的，因此总时间复杂度是 `O(n^3)`。